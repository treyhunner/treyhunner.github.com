/*!
 * Funnel Tools Capture Library v1.1.0
 * http://brandonhilkert.com/funnel-tools/capture
 *
 * Copyright 2015 Big Blue Media, LLC
 * http://brandonhilkert.com
 *
 * Date: 2015-02-20T13:58Z
 */

window.FunnelTools || (window.FunnelTools = {});
FunnelTools.Capture = {
  showTime: 32000,

  init: function(opts){
    if (opts && opts.showTime) {
      this.showTime = opts.showTime;
    }
    try {
      this.expiredStorage = new ExpiredStorage();
    } catch (exc) {
      console.error(exc);
    }

    this.widget().css('bottom', '-' + this.position() + "px");
    this.triggerShow(this.showTime);
  },
  widget: function() {
    return $("#funnel-tools-capture");
  },
  open: function() {
    return $("#funnel-tools-capture .open");
  },

  close: function() {
    return $("#funnel-tools-capture .close");
  },
  show: function(){
    this.widget().animate({ bottom: 0 }, 200);
    this.widget().addClass('open');
    if (this.expiredStorage) {
      this.expiredStorage.setItem('toasterShown', true, 3600*24*5);  // 5 days
    }
  },
  triggerShow: function(time) {
    var that = this;

    setTimeout(function() {
      if (!that.wasShown()) {
        that.show();
      }
    }, time);
  },
  wasShown: function () {
    return this.expiredStorage && this.expiredStorage.getItem('toasterShown');
  },
  hide: function(){
    this.widget().animate({ bottom: '-' + this.position() + 'px' }, 200);
    this.widget().removeClass('open');
  },
  toggle: function(){
    if (!this.isVisible()) {
      this.show();
    }
    else {
      this.hide();
    }
  },
  isVisible: function(){
    return this.widget().hasClass('open');
  },
  position: function() {
    return this.height() - this.titleHeight();
  },
  height: function() {
    return this.widget()[0].scrollHeight;
  },
  titleHeight: function() {
    if (this.widget().css('border-radius') == "0px") {
      return 30;
    } else {
      return 45;
    }
  }
}

$(document).on("click", "#funnel-tools-capture .title, #funnel-tools-capture .open, #funnel-tools-capture .close", function(){
  FunnelTools.Capture.toggle();
});

// Hide widget when clicking outside
$(document).click(function(event){
  if (!FunnelTools.Capture.isVisible()) {
    return;
  }
  if ($(event.target).parents("#funnel-tools-capture").length === 0) {
    FunnelTools.Capture.hide();
  }
});

function gaSend(obj) {
  if (typeof ga !== "undefined") {
    try {
      ga('send', obj);
    } catch (e) {
      console.error(e);
    }
  } else {
    console.error('Google Analytics not loaded on page.');
  }
}

$(document).ready(function(){
  FunnelTools.Capture.init();
  $("#funnel-tools-capture form").submit(function(event){
    var $form = $(event.target);
    var $submit = $form.find('*[type=submit]');
    var $title = $("#funnel-tools-capture .title");
    var $description = $("#funnel-tools-capture .description");
    var $email = $("#funnel-tools-capture input[type=email]");
    $submit
      .prop('disabled', true)
      .data('submitText', $submit.text())
      .text('Submitting...');
    gaSend({
      hitType: 'event',
      eventCategory: 'Python Morsels',
      eventAction: 'button click',
      eventLabel: 'Toaster Widget'
    });
    $.ajax({
      url: $form.attr('action'),
      method: 'POST',
      data: $form.serialize()
    }).always(function () {
      $submit
        .prop('disabled', false)
        .text($submit.data('submitText'));
    }).done(function (data, textStatus, xhr) {
      if (xhr.status == 201) {
        $title.html('Thanks for signing up!');
        $description.html('Please check your email to confirm your subscription.');
        gaSend({
          hitType: 'event',
          eventCategory: 'Python Morsels',
          eventAction: 'signup',
          eventLabel: 'Toaster Widget'
        });
      }
      else if (data.code == 1) {
        $description.html("You've already signed up with that email.  You can <a href=\"https://www.pythonmorsels.com/accounts/login/\">login here</a>.")
        gaSend({
          hitType: 'event',
          eventCategory: 'Python Morsels',
          eventAction: 'email already signed up',
          eventLabel: 'Toaster Widget'
        });
      }
      else if (data.code == 3) {
        $email.next('span.error').remove();
        $email.after('<span class="error">Email invalid</span>');
        $email.addClass('error');
        gaSend({
          hitType: 'event',
          eventCategory: 'Python Morsels',
          eventAction: 'email invalid',
          eventLabel: 'Toaster Widget'
        });
      } else {
        alert("An unexpected error occurred while submitting this form.  Sorry!  Please feel free to contact Trey to troubleshoot.");
        gaSend({
          hitType: 'event',
          eventCategory: 'Python Morsels',
          eventAction: 'server error',
          eventLabel: 'Toaster Widget'
        });
        console.error(data.reason);
      }
    }).fail(function (xhr, textStatus, error) {
      if (xhr.status == 401) {
        $description.html("You've already signed up with that email.  You can <a href=\"https://www.pythonmorsels.com/accounts/login/\">login here</a>.")
      }
      else if (xhr.status == 400) {
        $email.next('span.error').remove();
        $email.after('<span class="error">Email invalid</span>');
        $email.addClass('error');
      }
      else {
        alert("An unexpected error occurred while submitting this form.  Sorry!  Please feel free to contact Trey to troubleshoot.");
      }
    });
    event.preventDefault();
  });
  $("#funnel-tools-capture input[type=email]").focus(function(event) {
    var $email = $(event.target);
    $email.removeClass('error')
    $email.next('span.error').remove();
  });
});
